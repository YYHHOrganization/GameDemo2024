# ã€ŠåŸç¥ã€‹æ²™æ¼ æ•ˆæœå¤åˆ»

ä¸»è¦å‚è€ƒé“¾æ¥ï¼šhttps://zhuanlan.zhihu.com/p/568051545

è¿™é‡Œé™¤äº†ä¸Šè¿°é“¾æ¥ä¸­åšå®¢çš„åŸºæœ¬å†…å®¹ï¼Œä¹ŸåŠ å…¥äº†ä¸€äº›è‡ªå·±çš„ç†è§£ï¼Œå¹¶äº‰å–å¯¹ä»£ç è¿›è¡Œä¸€å®šçš„ä¿®æ”¹ï¼Œè®©æ•ˆæœæ›´å¥½ä¸€ç‚¹ã€‚



# ä¸€ã€åŸºæœ¬åŸç†ï¼ˆ1ï¼‰

## 1.ç»˜åˆ¶çš„åŸºæœ¬åŸç†

â€”â€”å¯¹äºç»˜åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æ¨¡ä»¿PSçš„ç»˜åˆ¶è¿‡ç¨‹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

![åŠ¨å›¾](./assets/v2-e8cb110290e08c658cf4ae9511150f52_b.webp)



â€‹	è¿™ä¸ªç»˜åˆ¶ï¼ˆæ·»åŠ æ–°çš„â€œåœ†ç‚¹â€ï¼‰çš„è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºä¸€ä¸ªè¿­ä»£ã€æˆ–è€…è¯´é€’å½’çš„è¿‡ç¨‹ï¼Œå³ç”¨åŸå›¾ç»è¿‡â€œåŠ ç‚¹â€æ–¹æ³•f(x)å¤„ç†è¾“å‡ºæ–°å›¾ï¼Œè€Œæ–°å›¾ä½œä¸ºä¸‹æ¬¡â€œåŠ ç‚¹â€å¤„ç†çš„åŸå›¾è¾“å…¥ï¼Œå¹¶é‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚

`ğ‘‡ğ‘’ğ‘¥ğ‘¡ğ‘¢ğ‘Ÿğ‘’_{ğ‘›+1}=ğ‘“(ğ‘‡ğ‘’ğ‘¥ğ‘¡ğ‘¢ğ‘Ÿğ‘’_{ğ‘›})`

â€‹	å¦‚æ­¤ä¸€æ¥ï¼Œåœ¨shaderä¸­åªéœ€è®¡ç®—å’Œæ–°åŠ çš„é‚£ä¸€ä¸ªâ€œåœ†ç‚¹â€ç›¸å…³çš„æ•°æ®å³å¯ï¼Œè€Œä¹‹å‰çš„ç»“æœéƒ½ä¿å­˜åœ¨äº†ä¸€å¼ å›¾åƒä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹çš„å®ç°æ–¹æ³•ä¹Ÿä¸å”¯ä¸€ï¼Œå¯ä»¥ç”¨Compute shaderæ¥å®ç°ï¼Œåœ¨è¿™ç¯‡åšå®¢ä¸­ä½¿ç”¨çš„æ˜¯tesselationæ–¹æ³•æ¥å®ç°ã€‚



## 2.è½¨è¿¹ä½“ç§¯çš„å®ç°

### ï¼ˆ1ï¼‰ç½®æ¢è´´å›¾ï¼ˆdisplacement mapï¼‰

â€‹	ä¸€èˆ¬æ˜¯ä¸€å¼ è®°å½•äº†è¡¨é¢å‡¹å‡¸ç¨‹åº¦ï¼ˆé«˜åº¦ï¼‰çš„ç°åº¦å›¾ï¼Œå¯ä»¥ç”¨å®ƒåœ¨é¡¶ç‚¹shaderä¸­æ”¹å˜æ¨¡å‹çš„é¡¶ç‚¹ä½ç½®ï¼ˆå®é™…ä¸Šæ¨¡å‹æœ¬èº«æ²¡å˜ï¼Œåªæ˜¯æœ€ç»ˆçœ‹ä¸Šå»çš„æ•ˆæœå˜äº†ã€‚**æœ€å¸¸è§çš„å¥—è·¯å°±æ˜¯ä¸‹é¢è¿™æ ·æ²¿æ³•çº¿æ–¹å‘è†¨èƒ€**ï¼‰ã€‚ä»¥ä¸‹æ˜¯ä¸¤ä¸ªåº”ç”¨displacement mapéœ€è¦æ³¨æ„çš„é—®é¢˜ï¼š

- è½¨è¿¹çš„å½¢çŠ¶å¯èƒ½å­˜åœ¨å¤–å›´æ¯”åœ°è¡¨é«˜ï¼Œå†…éƒ¨æ¯”åœ°è¡¨ä½çš„æƒ…å†µï¼Œæ—¢å¯ä»¥æ‹±å‡ºæ¥åˆå¯ä»¥å‹ä¸‹å»ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å¯¹displacement mapåšä¸€ä¸ªæ˜ å°„ï¼ŒæŠŠã€0ï¼Œ1ã€‘çš„ç°åº¦å€¼æ˜ å°„åˆ°ã€-1ï¼Œ1ã€‘ï¼Œä½œä¸ºé¡¶ç‚¹æ²¿æ³•çº¿åç§»çš„é‡ï¼›
- ç›´æ¥ä½¿ç”¨displacement mapçš„è¯ï¼Œé˜´å½±æ˜¯é”™è¯¯çš„ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ç”¨æ³•çº¿è´´å›¾ã€‚è™½ç„¶æ³•çº¿å¯ä»¥åŸºäºé«˜åº¦å›¾åœ¨shaderä¸­å®æ—¶è®¡ç®—ï¼Œä½†è€ƒè™‘åˆ°æ€§èƒ½å¼€é”€ä¸æ•ˆæœï¼Œè¿™é‡Œè¿˜æ˜¯ç”¨ç°æˆçš„æ³•çº¿è´´å›¾æ¥åšã€‚è¿™é‡Œå¯ä»¥åšä¸€ä¸ªå°ä¼˜åŒ–ï¼Œå……åˆ†åˆ©ç”¨é¢œè‰²é€šé“ï¼Œå°†æ³•çº¿ä¿¡æ¯å­˜åˆ°å›¾åƒçš„RGBé€šé“ï¼Œé«˜åº¦å­˜åˆ°Aé€šé“ä¸­ã€‚

ç»¼åˆä»¥ä¸Šä¸¤ç‚¹å¯ä»¥å¾—åˆ°ç±»ä¼¼äºä¸‹é¢çš„ç¬”åˆ·è´´å›¾ï¼š

![img](./assets/v2-7f96c17a5b195fba1cce50dbd8d43ab5_r.jpg)

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºè¿™é‡Œçš„æ³•çº¿æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ç¼–ç æ–¹å¼ï¼Œæ‰€ä»¥U3Dçš„å›¾åƒå¯¼å…¥è®¾ç½®ä¸­ä¸èƒ½é€‰NormalMapï¼Œshaderä¸­ä¹Ÿä¸èƒ½ç”¨UnpackNormalè§£ç ã€‚å¹¶ä¸”å› ä¸ºå­˜å‚¨çš„æ˜¯æ•°æ®ä¸æ˜¯é¢œè‰²ï¼Œæ‰€ä»¥ä¸èƒ½å‹¾é€‰sRGBã€‚ï¼ˆåŸå› å¯ä»¥å‚è€ƒæˆ‘çš„[è¿™ç¯‡æ–‡ç« ](https://link.zhihu.com/?target=https%3A//www.bilibili.com/read/cv18385963%3Fspm_id_from%3D333.999.0.0)ä¸­æœ«å°¾å…³äºçº¿æ€§å’ŒGammaç©ºé—´çš„é™ˆè¿°ï¼‰ã€‚**ä¹Ÿå°±æ˜¯è¯´è¿™å¼ å›¾éœ€è¦å–æ¶ˆå‹¾é€‰sRGBã€‚**

å¦‚æœåªæ˜¯ç”¨ä¸Šé¢çš„displacement mapå’Œæ³•çº¿è´´å›¾ï¼Œåˆ™æ•ˆæœè¿˜æ˜¯ä¸ä¼šå¤ªå¥½ï¼Œè¿™æ˜¯å› ä¸ºmeshçš„â€åˆ†è¾¨ç‡â€œå¤ªä½äº†ï¼Œ**è§£å†³æ–¹æ¡ˆæ˜¯å¯¹å…¶è¿›è¡Œæ›²é¢ç»†åˆ†ã€‚**

------



### ï¼ˆ2ï¼‰æ›²é¢ç»†åˆ†

æ›²é¢ç»†åˆ†å’Œå‡ ä½•shaderæ˜¯æ¸²æŸ“ç®¡çº¿ä¸­çš„ä¸¤ä¸ªå¯é€‰é˜¶æ®µã€‚ä¸€èˆ¬æˆ‘ä»¬å†™çš„shaderï¼Œå°¤å…¶æ˜¯ç§»åŠ¨ç«¯shaderåªä¼šç”¨åˆ°é¡¶ç‚¹å’Œç‰‡æ®µshaderï¼Œè€Œå®Œæ•´çš„æµç¨‹åˆ™æ˜¯é¡¶ç‚¹->æ›²é¢ç»†åˆ†->å‡ ä½•->ç‰‡æ®µã€‚

æŒ‰åšå®¢ä½œè€…çš„ç†è§£ï¼ˆæ³¨ï¼šæˆ‘ä¸ªäººè§‰å¾—ä¹Ÿå·®ä¸å¤šï¼Œåæ­£èƒ½æŠŠä»£ç å†™æ˜ç™½å°±è¡Œï¼‰ï¼Œæ›²é¢ç»†åˆ†é˜¶æ®µåˆå¯ä»¥è¿›ä¸€æ­¥åˆ†æˆã€é¡¶ç‚¹é˜¶æ®µæ•°æ®æ¥æ”¶ã€‘ã€ã€ç»†åˆ†è§„åˆ™é…ç½®ã€‘ã€ã€è®¡ç®—æ’å€¼æƒé‡ã€‘å’Œã€ç»†åˆ†åçš„é¡¶ç‚¹å±æ€§è®¡ç®—ã€‘å››éƒ¨åˆ†ã€‚è‹¥è¦ä½¿ç”¨æ›²é¢ç»†åˆ†shaderï¼Œé¦–å…ˆéœ€è¦åœ¨Passå†…çš„å¼€å¤´è¡¥ä¸Šä»¥ä¸‹å†…å®¹ï¼ˆç±»ä¼¼äºé¡¶ç‚¹ç€è‰²å™¨å’Œç‰‡å…ƒç€è‰²å™¨çš„å£°æ˜ï¼‰ï¼š

```glsl
#pragma hull hs
#pragma domain ds
```

ä¸‹é¢å¯¹å„é˜¶æ®µçš„è§£æåªè®¨è®ºå›¾å…ƒæ˜¯ä¸‰è§’å½¢æ—¶çš„æƒ…å†µã€‚

#### ï¼ˆaï¼‰é¡¶ç‚¹é˜¶æ®µæ•°æ®æ¥æ”¶

æ›²é¢ç»†åˆ†çš„ä½ç½®åœ¨é¡¶ç‚¹é˜¶æ®µåã€‚å‚ç…§é¡¶ç‚¹ä¸ç‰‡æ®µä¹‹é—´åˆ©ç”¨ç»“æ„ä½“åŠå¯¹åº”çš„æ–¹æ³•ä¼ é€’æ•°æ®çš„æ–¹å¼ï¼ˆåé¢å‡ ä¸ªé˜¶æ®µçš„æ•°æ®äº¤æ¢ä¹Ÿéƒ½ç±»ä¼¼ï¼‰ï¼Œæ›²é¢ç»†åˆ†ä¹Ÿéœ€è¦å®šä¹‰ä¸€ä¸ªç»“æ„ä½“æ¥æ¥æ”¶é¡¶ç‚¹é˜¶æ®µçš„æ•°æ®ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š

```glsl
//é¡¶ç‚¹shader
struct a2v
{
    float4 posOS	: POSITION;
    float3 nDirOS : NORMAL;
    float4 tDirOS : TANGENT;
    float2 uv0  : TEXCOORD0;
};
struct v2t  //æ›²é¢ç»†åˆ†ç»“æ„ä½“
{
    float3 posWS	: TEXCOORD0;
    float3 nDirWS : TEXCOORD1;
    float3 tDirWS : TEXCOORD2;
    float3 bDirWS    : TEXCOORD3;
    float2 uv0  : TEXCOORD4;
    float2 uv_Rut : TEXCOORD5; //å…ˆå¿½ç•¥è¿™ä¸ªï¼Œåé¢ä¼šè¯´
};
```

æ­¤æ—¶é¡¶ç‚¹ç€è‰²å™¨æ˜¯è¿™æ ·çš„ï¼š

```glsl
v2t vert(a2v i)
{
    v2t o;

    //åæ ‡
    o.posWS = TransformObjectToWorld(i.posOS.xyz);

    //å‘é‡
    o.nDirWS = TransformObjectToWorldNormal(i.nDirOS);
    o.tDirWS = TransformObjectToWorldDir(i.tDirOS.xyz);
    o.bDirWS = cross(o.nDirWS, o.tDirWS) * i.tDirOS.w;

    //UV
    o.uv0 = i.uv0; 
    o.uv_Rut = float2(Remap(_PaintRect.x, _PaintRect.z, o.posWS.x), Remap(_PaintRect.y, _PaintRect.w, o.posWS.z)); //å…ˆå¿½ç•¥è¿™ä¸ªï¼Œåé¢ä¼šè¯´

    return o;
}
```

------



#### ï¼ˆbï¼‰ç»†åˆ†è§„åˆ™é…ç½®

å³å¦‚ä½•å¯¹ä¸€ä¸ªä¸‰è§’é¢è¿›è¡Œç»†åˆ†ã€‚åœ¨æ›²é¢ç»†åˆ†çš„æµç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸‰è§’å½¢å„è¾¹è¦åˆ†æˆå‡ æ®µï¼Œä»¥åŠä¸‰è§’å½¢å†…éƒ¨æœ‰å‡ ä¸ªæ–°åŠ çš„ç‚¹ï¼ˆå®é™…ä¸Šä¸æ˜¯ç‚¹çš„æ•°é‡ã€‚å†…éƒ¨ç‚¹çš„ç»†åˆ†æ•°å¹¶ä¸ç›´è§‚ï¼‰ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å£°æ˜ä¸‹é¢è¿™ä¹ˆä¸ªç»“æ„ä½“ç”¨æ¥å­˜å‚¨ç»†åˆ†é…ç½®ï¼š

```glsl
//å¯¹ä¸‰è§’é¢æˆ–å…¶ä»–å½¢å¼å›¾å…ƒè¿›è¡Œç»†åˆ†çš„é…ç½®
struct TessParam
{
    float EdgeTess[3]	: SV_TessFactor;//å„è¾¹ç»†åˆ†æ•°
    float InsideTess	    : SV_InsideTessFactor;//å†…éƒ¨ç‚¹ç»†åˆ†æ•°
};
```

ç´§æ¥ç€è¿™ä¸ªç»“æ„ä½“ä¸‹é¢å†™è¿™ä¹ˆä¸ªæ–¹æ³•æ¥ç®—å…·ä½“æ€ä¹ˆåˆ†ï¼Œåé¢å‡ ä¸ªé˜¶æ®µä¹Ÿæ˜¯ç±»ä¼¼çš„æ ¼å¼ï¼š

```glsl
TessParam ConstantHS(InputPatch<v2t, 3> i, uint id : SV_PrimitiveID)
{
  TessParam o;

  o.EdgeTess[0] = ç¬¬1æ¡è¾¹çš„ç»†åˆ†æ®µæ•°;
  o.EdgeTess[1] = ç¬¬2æ¡è¾¹çš„ç»†åˆ†æ®µæ•°;
  o.EdgeTess[2] = ç¬¬3æ¡è¾¹çš„ç»†åˆ†æ®µæ•°;
  o.InsideTess = å†…éƒ¨ç»†åˆ†ç‚¹ç³»æ•°;

  return o;
}
```

ä¸Šé¢è¿™ä¸ªæ–¹æ³•åœ¨è¿è¡Œæ—¶ä¼šåœ¨åŸæ¨¡å‹çš„æ¯ä¸ªä¸‰è§’é¢ä¸Šè·‘ä¸€éã€‚å‚æ•°åˆ—è¡¨ä¸­çš„`i`å¯ä»¥è·å¾—ä¹‹å‰åœ¨é¡¶ç‚¹é˜¶æ®µä¼ åˆ°æ›²é¢ç»†åˆ†ç»“æ„ä½“é‡Œçš„æ•°æ®ï¼Œå¹¶ä¸”æ˜¯ä¸‰ä»½ï¼ˆä¸€ä¸ªä¸‰è§’é¢ä¸Šçš„ä¸‰ä¸ªé¡¶ç‚¹ï¼‰ã€‚å¦‚æœéœ€è¦åšä¸€äº›å±€éƒ¨ç»†åˆ†çš„ä¼˜åŒ–ï¼Œå¯èƒ½å°±éœ€è¦ç”¨åˆ°å®ƒã€‚

> æ³¨æ„ï¼šè¿™é‡Œå¯ä»¥æƒ³åˆ°ä¸€ä¸ªä¼˜åŒ–ç‚¹ï¼Œå³åœ¨éœ€è¦è¶³è¿¹çš„åœ°æ–¹ä½¿ç”¨tessellationï¼Œè€Œåœ¨æ¯”å¦‚ç¦»è§’è‰²è„šå°å¾ˆè¿œçš„ä½ç½®åˆ™ä¸éœ€è¦è¿›è¡Œtessellationï¼Œè¿™ä¸ªä¼˜åŒ–ç­–ç•¥ä¼šåœ¨åé¢çš„å…·ä½“ä»£ç åˆ†æéƒ¨åˆ†è¿›è¡Œåˆ†æã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ç§å‚æ•°å¯¹æ¨¡å‹çš„å®é™…å½±å“ï¼š

![åŠ¨å›¾](./assets/v2-baa97ab7c2c96040543c95be105162cd_b.webp)

- å³è¾¹å‚æ•°çš„xyzåˆ†é‡å¯¹åº”è¾¹çš„ç»†åˆ†æ®µæ•°ï¼Œwå¯¹åº”å†…éƒ¨ç»†åˆ†ç‚¹ç³»æ•°ã€‚

  > éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯è¿™é‡Œæœ‰ä¸ªå‘ï¼Œå¦‚æœæŠŠä¸‰æ¡è¾¹çš„ç»†åˆ†æ®µæ•°å…¬å¼€æˆä¸‰ä¸ªä¸åŒçš„å‚æ•°æ¥æ§åˆ¶ä¼šå‡ºé—®é¢˜ï¼Œç½‘æ ¼ä¼šå®Œå…¨æ¶ˆå¤±ï¼ˆæˆ–é—ªçƒï¼‰ï¼Œä½†åšå®¢ä½œè€…ä¸æ¸…æ¥šåŸå› ã€‚ä»¥é˜²ä¸‡ä¸€å¦‚æœåé¢éœ€è¦å¯¹æ¯ä¸ªå‚æ•°å•ç‹¬æ§åˆ¶çš„è¯ç»™ä¸ª`float3`å§ï¼Œè€Œä¸æ˜¯ä¸‰ä¸ªfloatã€‚

- å¯¹äºè¿™å‡ ä¸ªå‚æ•°ï¼Œå…¶ä¸­çš„EdgeTesså¾ˆç›´è§‚ï¼Œç»™å¤šå°‘ï¼Œå¯¹åº”çš„è¾¹å°±ä¼šè¢«åˆ†æˆå‡ æ®µï¼›è€Œå¯¹äºInsideTessï¼Œç»è§‚å¯Ÿå¯ä»¥å‘ç°å®ƒåªä¼šå½±å“å†…å±‚ä¸‰è§’å½¢çš„ç»†åˆ†ç‚¹æ’åˆ—æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´EdgeTessä¸InsideTessæ˜¯äº’ç›¸ç‹¬ç«‹çš„ã€‚
- ä»¥ä¸€äº›ç®€å•çš„ç­‰å·®æ•°åˆ—çŸ¥è¯†å¯ä»¥ç®—å‡ºæ¥ï¼ŒInsideTessç³»æ•°ä¸å†…éƒ¨çš„ç»†åˆ†ç‚¹ä¸ªæ•°é—´çš„å…³ç³»å¦‚ä¸‹ï¼ˆæ³¨ï¼šä¸è¿‡è¿™ä¸ªåœ¨å®é™…å†™ä»£ç çš„æ—¶å€™ä¹Ÿä¸æ˜¯é‚£ä¹ˆéœ€è¦å…³å¿ƒï¼‰ï¼š
  - ![image-20240717213728826](./assets/image-20240717213728826.png)â€”â€”å…¶ä¸­Næ˜¯ä¸‰è§’å½¢å†…éƒ¨å¢åŠ çš„ç‚¹çš„ä¸ªæ•°ï¼›xæ˜¯InsideTessç»™çš„æ•°ï¼›kåœ¨xæ˜¯å¥‡æ•°æ—¶ä¸º0ï¼Œå¶æ•°æ—¶ä¸º1ã€‚

------



#### ï¼ˆcï¼‰è®¡ç®—æ’å€¼æƒé‡

â€‹	è¿™ä¸ªé˜¶æ®µæ˜¯**ä¸å¯ç¼–ç¨‹çš„**ã€‚ä»–ä¼šæ ¹æ®æˆ‘ä»¬ä¹‹å‰å’Œä¸‹é¢çš„ç»†åˆ†é…ç½®åœ¨ç¡¬ä»¶å†…éƒ¨è¿›è¡Œè®¡ç®—ï¼Œå¹¶å¾—åˆ°æ¯ä¸ªæ–°é¡¶ç‚¹çš„æ’å€¼æƒé‡ï¼Œæˆ–è€…è¯´æ‰€è°“çš„â€œé‡å¿ƒç©ºé—´åæ ‡â€ï¼ˆå…¶å®æŸç§å±‚é¢ä¸Šç±»ä¼¼äºç‰‡æ®µshaderå‰çš„å…‰æ …åŒ–çº¿æ€§æ’å€¼é˜¶æ®µï¼Œåªä¸è¿‡è¿™é‡Œæ’å€¼è®¡ç®—çš„æ˜¯é¡¶ç‚¹è€Œä¸æ˜¯åƒç´ ã€‚å¹¶ä¸”è¿™ä¸€æ­¥åªæ˜¯å¾—åˆ°æ¯ä¸ªé¡¶ç‚¹çš„æ’å€¼æƒé‡ï¼ŒçœŸæ­£çš„æ··åˆéœ€è¦æˆ‘ä»¬åœ¨ä¸‹ä¸€ä¸ªé˜¶æ®µæ‰‹åŠ¨è®¡ç®—ï¼‰ã€‚ä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œè¿˜éœ€è¦å†™ä¸€äº›é…ç½®æ–¹é¢çš„ä¸œè¥¿ï¼š

```glsl
//å°†åŸæ¨¡å‹é¡¶ç‚¹å±æ€§æŒ‰æŒ‡å®šå›¾å…ƒæ‰“åŒ…ï¼Ÿ
struct TessOut
{
    float3 posWS	: TEXCOORD0;
    float3 nDirWS : TEXCOORD1;
    float3 tDirWS : TEXCOORD2;
    float3 bDirWS    : TEXCOORD3;
    float2 uv0  : TEXCOORD4;
    float2 uv_Rut : TEXCOORD5;
};
[domain("tri")]//å›¾å…ƒç±»å‹
[partitioning("integer")]//æ›²é¢ç»†åˆ†çš„è¿‡æ¸¡æ–¹å¼æ˜¯æ•´æ•°è¿˜æ˜¯å°æ•°
[outputtopology("triangle_cw")]//ä¸‰è§’é¢æ­£æ–¹å‘æ˜¯é¡ºæ—¶é’ˆè¿˜æ˜¯é€†æ—¶é’ˆ
[outputcontrolpoints(3)]//è¾“å‡ºçš„æ§åˆ¶ç‚¹æ•°
[patchconstantfunc("ConstantHS")]//å¯¹åº”ä¹‹å‰çš„ç»†åˆ†å› å­é…ç½®é˜¶æ®µçš„æ–¹æ³•å
[maxtessfactor(64.0)]//æœ€å¤§å¯èƒ½çš„ç»†åˆ†æ®µæ•°
TessOut hs(InputPatch<v2t, 3> i, uint idx : SV_OutputControlPointID)//åœ¨æ­¤å¤„è¿›è¡Œçš„æ“ä½œæ˜¯å¯¹åŸæ¨¡å‹çš„æ“ä½œï¼Œè€Œéç»†åˆ†å
    //ç›®å‰æ¥è¯´å°±æ˜¯ç›´æ¥èµ‹å€¼å°±å¥½ï¼Œæ²¡çœ‹å‡ºæ¥å…·ä½“æœ‰ä»€ä¹ˆç”¨ï¼Œä¸å½±å“å†™ä»£ç 
{
    TessOut o;
    o.posWS = i[idx].posWS;
    o.nDirWS = i[idx].nDirWS;
    o.tDirWS = i[idx].tDirWS;
    o.bDirWS = i[idx].bDirWS;
    o.uv0 = i[idx].uv0;
    o.uv_Rut = i[idx].uv_Rut;
    return o;
}
```

> è¿™æ®µä¸­é—´çš„é‚£å‡ è¡Œä¸­æ‹¬å·ã€ã€‘æ‹¬èµ·æ¥çš„é…ç½®è¿˜æ˜¯æœ‰ä¸€å®šå½±å“çš„ï¼Œä½†ä¸€èˆ¬éœ€è¦åŠ¨çš„å¯èƒ½ä¹Ÿå°±ç¬¬äºŒè¡Œã€‚é™¤äº†integerï¼Œå¯é€‰çš„å­—æ®µè¿˜æœ‰fractional_oddå’Œfractional_evenä¸¤ç§ã€‚åä¸¤ç§çš„æ•ˆæœç±»ä¼¼ï¼Œéƒ½æ˜¯æœ‰ä¸ªå¹³æ»‘è¿‡æ¸¡çš„è¿‡ç¨‹ã€‚é’ˆå¯¹`[partitioning("integer")]`ä¸åŒå‚æ•°çš„åŒºåˆ«å¯ä»¥çœ‹ä¸‹é¢çš„é“¾æ¥ï¼š
>
> https://vdn6.vzuu.com/SD/58b4f3f6-3cd2-11ed-b64d-1636829a506b.mp4?pkey=AAUW9DHw1MLquNX-oQaPDlfL_qemBqxumJsW_uwud3zq8DauwmH7oi_6Ng5DM00-pleWWHeAS5PmCizCRWAn1jm1&bu=078babd7&c=avc.1.1&expiration=1721230816&f=mp4&pu=078babd7&v=ks6



#### ï¼ˆdï¼‰**ç»†åˆ†åçš„é¡¶ç‚¹å±æ€§è®¡ç®—**

â€‹	åˆ°è¿™é‡Œå°±æ˜¯ç»†åˆ†ç€è‰²å™¨çš„æœ€åä¸€æ­¥äº†ã€‚è¿™ä¸€æ­¥çš„æ–¹æ³•å…¶å®ç›¸å½“äºä¸€èˆ¬é¡¶ç‚¹-ç‰‡æ®µshaderä¸­çš„é¡¶ç‚¹é˜¶æ®µï¼Œåƒæ˜¯2.1ä¸­çš„ç½®æ¢è´´å›¾æ³•çº¿è†¨èƒ€ç®—æ³•æˆ–æ˜¯å…¶ä»–å¸¸è§çš„å†™åœ¨é¡¶ç‚¹é˜¶æ®µçš„ç®—æ³•å°±å¯ä»¥å†™åœ¨è¿™é‡Œã€‚åªä¸è¿‡ç»è¿‡äº†å‰é¢çš„ç»†åˆ†å¤„ç†ï¼Œ**è¿™é‡Œæ‰€å¤„ç†çš„é¡¶ç‚¹ä¸æ˜¯åŸæ¨¡å‹çš„é¡¶ç‚¹ï¼Œè€Œæ˜¯ç»†åˆ†åçš„æ‰€æœ‰é¡¶ç‚¹ã€‚**çœ‹ä»£ç ï¼š
```glsl
struct t2f
{
    float4 posCS	       : SV_POSITION;
    float3 posWS            : TEXCOORD7;
    float3 nDirWS       : TEXCOORD0;
    float3 tDirWS       : TEXCOORD1;
    float3 bDirWS       : TEXCOORD2;
    float3 vDirWS       : TEXCOORD3;
	//...åé¢ä»£ç åˆ†æä¸­å…·ä½“ä¼šè¯´
};
[domain("tri")]
t2f ds(TessParam tessParam, float3 bary : SV_DomainLocation, const OutputPatch<TessOut, 3> i)
{
    t2f o;   

    //çº¿æ€§è½¬æ¢
    o.posWS = i[0].posWS * bary.x + i[1].posWS * bary.y + i[2].posWS * bary.z;
    o.nDirWS = i[0].nDirWS * bary.x + i[1].nDirWS * bary.y + i[2].nDirWS * bary.z;
    o.tDirWS = i[0].tDirWS * bary.x + i[1].tDirWS * bary.y + i[2].tDirWS * bary.z;
    o.bDirWS = i[0].bDirWS * bary.x + i[1].bDirWS * bary.y + i[2].bDirWS * bary.z;
    //...åé¢ä»£ç åˆ†æä¸­å…·ä½“ä¼šè¯´

    return o;
}
```

å…¶å®è¿™é‡Œçš„`ds`å‡½æ•°çš„ä¼ å…¥å‚æ•°ä¹‹ä¸€`bary`æŒ‡çš„å°±æ˜¯é‡å¿ƒåæ ‡ï¼Œè€Œä¸‹é¢å‡½æ•°ä½“å†…æš‚æ—¶å±•ç¤ºçš„éƒ¨åˆ†å°±æ˜¯é‡å¿ƒæ’å€¼çš„æ€è·¯ã€‚æœ€ç»ˆå†æŠŠ`t2f`ä½œä¸ºç‰‡å…ƒç€è‰²å™¨çš„è¾“å…¥å‚æ•°å³å¯ï¼š
```glsl
float4 frag(t2f i) : SV_Target
{
	//åƒç´ å¤„ç†
}
```



#### ï¼ˆeï¼‰æ›²é¢ç»†åˆ†ç€è‰²å™¨çš„å…¶ä»–å‚è€ƒèµ„æ–™

ã€1ã€‘https://blog.csdn.net/suixinger_lmh/article/details/125140224

ã€2ã€‘https://blog.csdn.net/ifenghua135792468/article/details/106851708/

ã€3ã€‘https://blog.csdn.net/WINDGRIN23313/article/details/120128498

------



### ï¼ˆ3ï¼‰Displacement map + tessellation

åŸºäºä¹‹å‰åšçš„[æ²™æ¼ æè´¨çƒ](https://link.zhihu.com/?target=https%3A//www.bilibili.com/read/cv18488420%3Fspm_id_from%3D333.999.0.0)ï¼Œå°†ä¸Šè¿°ä¸¤ç§æŠ€æœ¯åŠ è¿›å»ã€‚é¦–å…ˆæ˜¯å¯¹normal+displacementçš„åº”ç”¨ï¼Œè¿™ä¸ªå†™åœ¨domain shaderå½“ä¸­å³å¯ï¼š

```glsl
t2f ds(TessParam tessParam, float3 bary : SV_DomainLocation, const OutputPatch<TessOut, 3> i)
{
    t2f o;   

    //çº¿æ€§è½¬æ¢
    o.posWS = i[0].posWS * bary.x + i[1].posWS * bary.y + i[2].posWS * bary.z;
    o.nDirWS = i[0].nDirWS * bary.x + i[1].nDirWS * bary.y + i[2].nDirWS * bary.z;
    o.tDirWS = i[0].tDirWS * bary.x + i[1].tDirWS * bary.y + i[2].tDirWS * bary.z;
    o.bDirWS = i[0].bDirWS * bary.x + i[1].bDirWS * bary.y + i[2].bDirWS * bary.z;
    float2 uv0 = i[0].uv0 * bary.x + i[1].uv0 * bary.y + i[2].uv0 * bary.z;
    o.uv_Rut = i[0].uv_Rut * bary.x + i[1].uv_Rut * bary.y + i[2].uv_Rut * bary.z;  //è¿™é‡Œçš„uv_Rutæš‚æ—¶æ˜¯å°†ç‰©ä½“ä¸–ç•Œç©ºé—´ä¸‹çš„åæ ‡xå’Œz remapåˆ°0-1ä¹‹é—´çš„UVå€¼

    //ç—•è¿¹å˜å½¢
    float height = tex2Dlod(_RutRTTex, float4(o.uv_Rut, 0, 0)).a;
    height = abs(height - 0.5) < minError ? 0.5 : height;//è¯¯å·®æˆªæ–­ï¼Œé˜²æ­¢åœ¨å¹³å¦åŒºåŸŸäº§ç”Ÿå˜å½¢
    o.posWS += _RutHeight * (2.0 * height - 1.0) * o.nDirWS;

    //åæ ‡
    o.posCS = TransformWorldToHClip(o.posWS);

    //å‘é‡
    o.vDirWS = GetCameraPositionWS() - o.posWS;

    //UV
    o.uv_Main = TRANSFORM_TEX(uv0, _MainTex);
    o.uv_Flash.xy = TRANSFORM_TEX(uv0, _FlashTex);

    //é—ªçƒå†…å±‚UVåç§»
    float3x3 TBN = float3x3(normalize(o.tDirWS), normalize(o.bDirWS), normalize(o.nDirWS));
    float3 vDirTS = TransformWorldToTangent(o.vDirWS, TBN);
    o.uv_Flash.zw = GetPosAnyPlaneCrossDir(float3(0, 0, _FlashOffset), float3(o.uv_Flash.xy, 0), float3(0,0,1), vDirTS).xy;

    return o;
}
```

ç‰‡å…ƒç€è‰²å™¨åˆ™è´Ÿè´£åšæ²™æ¼ æ²™å­çš„é—ªçƒæ•ˆæœï¼Œä»¥åŠåº”ç”¨æ³•çº¿è´´å›¾å’Œè®¡ç®—å…‰ç…§ï¼Œä»£ç å¦‚ä¸‹ï¼ˆä»£ç ä¸­æœ‰ä¸€äº›ç»†èŠ‚ï¼Œä¾‹å¦‚å°è¯¯å·®æˆªæ–­ï¼Œä¼šåœ¨åé¢çš„éƒ¨åˆ†ä¸­è¿›è¡Œä»‹ç»ï¼‰ï¼š

```glsl
float4 frag(t2f i) : SV_Target
{
    //è½¨è¿¹å›¾é‡‡æ ·
    float4 var_RutTex = tex2D(_RutRTTex, i.uv_Rut);
    var_RutTex.xyw = abs(var_RutTex.xyw - 0.5) < minError ? 0.5 : var_RutTex.xyw;//è¯¯å·®æˆªæ–­ï¼Œé˜²æ­¢åœ¨å¹³å¦åŒºåŸŸåº”ç”¨æ³•çº¿è´´å›¾

    //åœ°å½¢æ³•çº¿
    float3 nDirTS = UnpackNormal(tex2D(_NormalMap, i.uv_Main));
    nDirTS.xy *= _NormalInt;

    //è½¨è¿¹æ³•çº¿
    float3 nDirTS_Rut = (2.0 * var_RutTex.xyz - 1.0);
    nDirTS_Rut.xy *= _RutHeight * _RutNormalInt;

    //æ³•çº¿æ··åˆ
    nDirTS = normalize(float3(nDirTS.xy / nDirTS.z + nDirTS_Rut.xy / nDirTS_Rut.z, 1.0));
    float3x3 TBN = float3x3(normalize(i.tDirWS), normalize(i.bDirWS), normalize(i.nDirWS));

    //todo:å¯ä»¥ç”¨æ›´å¥½çš„æ³•çº¿æ··åˆæ–¹æ¡ˆï¼šhttps://www.gameres.com/896279.html

    //å‘é‡
    Light light = GetMainLight(TransformWorldToShadowCoord(i.posWS));
    float3 nDirWS = normalize(mul(nDirTS, TBN));
    float3 lDirWS = light.direction;
    float3 vDirWS = normalize(i.vDirWS);
    float3 hDirWS = normalize(lDirWS + vDirWS);

    //å…‰ç…§
    float lambert = saturate(dot(nDirWS, lDirWS));
    float blinn = lambert * pow(saturate(dot(nDirWS, hDirWS)), 1.0 / (_Rough*_Rough));
    float3 baseCol = tex2D(_MainTex, i.uv_Main).rgb;
    float3 diffuseCol = baseCol * lerp(_DarkCol, _BrightCol, lambert);
    float3 specularCol = _SpecularCol * blinn;

    //ç¯å¢ƒå…‰
    float nv = saturate(dot(nDirWS, vDirWS));
    float fresnel = _F0 + (1.0-_F0) * pow(1.0 - nv, _FresnelPow);
    float3 ambCol = fresnel * _AmbCol * baseCol;

    //é—ªçƒ
    float flashMask = Remap(_FlashRange_Max, _FlashRange_Min, length(i.vDirWS));
    float mask0 = tex2D(_FlashTex, i.uv_Flash.xy).r;
    float mask1 = tex2D(_FlashTex, i.uv_Flash.zw).r;
    float flashCol = _FlashInt * flashMask * mask0 * mask1;

    //æ··åˆ
    float3 finalCol = (diffuseCol + specularCol + flashCol) * light.shadowAttenuation + ambCol;
    return float4(finalCol, 1.0);
}    
```





------



## 3.è½¨è¿¹çš„åŠ¨æ€ç»˜åˆ¶

### ï¼ˆ1ï¼‰`Graphics.Blit`

è¿™éƒ¨åˆ†æ˜¯åœ¨C#è„šæœ¬å½“ä¸­å»å†™çš„ã€‚ï¼ˆæ³¨ï¼šæˆ‘ä»¥å‰ä»¥ä¸º`Graphics.Blit`æ˜¯ä¸èƒ½åœ¨URPä¸­å†™çš„ï¼Œçœ‹èµ·æ¥åº”è¯¥æ˜¯å¯ä»¥ï¼ï¼ï¼‰ï¼Œæ ¸å¿ƒéƒ¨åˆ†æ˜¯ä¸‹é¢çš„ä»£ç ï¼š
```c#
public RenderTexture paintRT;//è½¨è¿¹æ¸²æŸ“çº¹ç† RGBæ³•çº¿ Aé«˜åº¦
Material paintMat;//ç»˜åˆ¶å¤„ç†ç”¨çš„æè´¨
void Paint(Texture2D brushTex/*å…¶ä»–å‚æ•°*/)
{
  //å…¶ä»–è®¡ç®—
  
  //ç»˜åˆ¶æè´¨å‚æ•°é…ç½®
  paintMat.SetTexture("_BrushTex", brushTex);//ç¬”åˆ·è´´å›¾
  /*å…¶ä»–å‚æ•°è®¾ç½®Â·Â·Â·*/
  
  //çº¹ç†äº¤æ¢
  RenderTexture tempRT = RenderTexture.GetTemporary(paintRT.descriptor);
  Graphics.Blit(paintRT, tempRT, paintMat, 0);
  Graphics.Blit(tempRT, paintRT);
  RenderTexture.ReleaseTemporary(tempRT);
}
```

> å¯¹ä¸Šè¿°ä»£ç çš„è§£è¯»ï¼š
>
> - å®šä¹‰ä¸€ä¸ªPaintæ–¹æ³•ã€‚å…¶ä¸­ï¼ŒpaintRTæ˜¯æ—§çš„è½¨è¿¹å›¾ï¼ŒåŒæ—¶ä¹Ÿæ˜¯åœ°å½¢ä½¿ç”¨çš„displacement map+normal mapï¼› paintMatæ˜¯æˆ‘ä»¬ä¸€ä¼šè¦å†™çš„ç»˜åˆ¶ç”¨çš„shaderå®ä¾‹åŒ–å‡ºæ¥çš„ä¸€ä¸ªæè´¨ï¼›brushTexæ˜¯åœ¨æœ¬æ¬¡ç»˜åˆ¶ä¸­ä½¿ç”¨çš„ç¬”åˆ·è´´å›¾ï¼ˆä¸€ä¸ªæ³•çº¿é«˜åº¦æ··åˆå›¾ï¼Œå¯ä»¥çœ‹åŸåšå®¢çš„2.1éƒ¨åˆ†ï¼Œå°±æ˜¯ä¸€ä¸ªæœ‰displacement mapå’Œnormal mapçš„ç¬”åˆ·è´´å›¾ï¼‰ã€‚
> - å®Œæˆæè´¨çš„å‚æ•°ä¼ é€’åï¼Œæˆ‘ä»¬å…ˆç”¨`RenderTexture.GetTemporary`æ–¹æ³•åˆ›å»ºä¸€ä¸ªäº¤æ¢ç”¨çš„ä¸´æ—¶RTï¼ˆè¯´æ˜¯ç”¨è¿™ä¸ªæ–¹æ³•çš„æ€§èƒ½æ¯”è¾ƒå¥½ï¼‰ï¼›
> - ç„¶å`Graphics.Blit(paintRT, tempRT, paintMat, 0)`è¿™å¥çš„æ„æ€æ˜¯ï¼šã€æŠŠpaintRTç”¨paintMatå¤„ç†ä¸€æ¬¡åçš„å›¾åƒä¼ ç»™tempRTã€‘ï¼ˆ0çš„æ„æ€æ˜¯ä½¿ç”¨shaderä¸­çš„ç¬¬å‡ ä¸ªpassï¼Œä¸€èˆ¬å°±ç”¨ç¬¬ä¸€ä¸ªï¼Œå°¤å…¶æœ¬æ–‡çš„URPç®¡çº¿ï¼‰ã€‚**éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒBlitä¼šé»˜è®¤æŠŠpaintRTä¼ ç»™shaderä¸­åä¸º_MainTexçš„å˜é‡ï¼Œæ‰€ä»¥å†™shaderæ—¶åå­—è¦å¯¹åº”ï¼›**
> - æ¥ç€ï¼Œ`Graphics.Blit(tempRT, paintRT)`æ˜¯å°†tempRTçš„ç»“æœä¼ å›paintRTï¼Œå®Œæˆä¸€æ¬¡è¿­ä»£è¿‡ç¨‹ï¼›æœ€åä¸€å®šè¦ç”¨`ReleaseTemporary`æ‰‹åŠ¨é‡Šæ”¾ä¸´æ—¶RTçš„å†…å­˜ï¼ï¼ˆå¦åˆ™å°±ç­‰ç€å†…å­˜çˆ†ç‚¸å§ï¼Œä¸è¦é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„ï¼‰



### ï¼ˆ2ï¼‰ç¬”åˆ·ç»˜åˆ¶shader

â€‹	ä¸Šé¢çš„Blitæ–¹æ³•éœ€è¦ä»¥ä¸€ä¸ªpaintMatä½œä¸ºå¤„ç†æè´¨ï¼Œå…¶å¯¹åº”çš„ä¾¿æ˜¯æ¥ä¸‹æ¥çš„ç»˜åˆ¶shaderã€‚ ç»“åˆå‰é¢çš„åˆ†æä¸ä¸Šè¿°è¿‡ç¨‹ï¼Œæˆ‘ä»¬ç»˜åˆ¶ç”¨çš„shaderå…¶å®åªéœ€è¦å…³æ³¨â€œå•æ­¥æ“ä½œâ€å³å¯ï¼Œå³â€œå¦‚ä½•æŠŠä¸€å¼ ç¬”åˆ·å›¾è´´åˆ°æ—§çš„è½¨è¿¹å›¾ä¸Šå»â€ã€‚

å…ˆè€ƒè™‘ä¸€ä¸‹ï¼Œè¿™ä¸ªshaderå¯èƒ½éœ€è¦ç”¨åˆ°ä»€ä¹ˆå‚æ•°ã€‚

- é¦–å…ˆï¼Œæ—§çš„è½¨è¿¹å›¾å’Œç¬”åˆ·å›¾æ˜¯å¿…é¡»çš„ï¼›
- ç„¶åæ˜¯â€œåœ¨å“ªç”»â€ï¼Œå³ç¬”åˆ·çš„UVåæ ‡ï¼ˆè¿™é‡Œéœ€è¦è¡¥å……ä¸€ä¸‹ï¼ŒGraphics.Blitæ–¹æ³•å®é™…ä¸Šæ˜¯åœ¨ä¸€ä¸ªUVèŒƒå›´æ˜¯0~1çš„æ–¹å½¢ç½‘æ ¼ä¸Šè¿›è¡Œç›¸å…³è®¡ç®—çš„ï¼Œæ‰€ä»¥UVåæ ‡ä¹Ÿå°±ç›¸å½“äºè´´å›¾å½’ä¸€åŒ–çš„åƒç´ åæ ‡ï¼‰ï¼›
- è¿˜æœ‰â€œç”»å¤šå¤§â€ï¼Œå³ç¬”åˆ·åœ¨UVç©ºé—´ä¸­çš„åŠå¾„ï¼›
- æœ€åè¿˜å¯ä»¥åŠ ä¸ªå¼ºåº¦ï¼Œæˆ–è€…è¯´é€æ˜åº¦ã€‚

â€‹	æ˜¾ç„¶ï¼Œå¦‚æœè¦æŠŠâ€ç¬”åˆ·â€œç»˜åˆ¶åœ¨åœ°å½¢ä¸Šï¼Œè¿™é‡Œä¸€å®šéœ€è¦ä¸€æ­¥**æ³•çº¿è´´å›¾æ··åˆçš„æ“ä½œ**ã€‚**æ³•çº¿è´´å›¾æ··åˆçš„æ“ä½œå¼ºçƒˆå»ºè®®é˜…è¯»è¿™ä¸ªæ–‡ç« ï¼šhttps://www.gameres.com/896279.html**ï¼ˆå…·ä½“çš„æ•°å­¦æš‚æ—¶ä¸éœ€è¦äº†è§£ï¼Œä½†è¦åšåˆ°æ‹¿æ¥å³ç”¨ï¼‰ã€‚

â€‹	æ³•çº¿é‡‡ç”¨ä¹‹å‰ä¸€ç¯‡æ–‡ä¸­è¯´è¿‡çš„[åå¯¼æ•°](https://link.zhihu.com/?target=https%3A//www.bilibili.com/read/cv18524352%3Fspm_id_from%3D333.999.0.0)çš„æ··åˆæ–¹å¼ï¼Œé«˜åº¦ç›´æ¥åœ¨è§£ç åç›¸åŠ ï¼Œæœ€åç¼–ç ï¼ˆç‰¹åˆ«è¯´æ˜ï¼ŒåŸç¥ä¸­çš„é«˜åº¦æ··åˆæ˜¾ç„¶ä¸æ˜¯è¿™ç§æ–¹å¼ã€‚ç»è¿‡æˆ‘å°è¯•ï¼Œå®ƒåº”è¯¥æ˜¯ä¸€ç§æ¯”è¾ƒåå–æœ€å¤§/æœ€å°çš„ç®—æ³•ï¼Œè¿™ä¸ªåé¢çš„åšå®¢å¥½åƒæœ‰è¯´ã€‚==todoï¼šåé¢çœ‹åˆ°çš„è¯å†å›æ¥è¡¥å……å§==ï¼‰ã€‚

```c#
//åœ°å½¢æ³•çº¿
float3 nDirTS = UnpackNormal(tex2D(_NormalMap, i.uv_Main)); //è¿™ä¸ªæŒ‡çš„æ˜¯æ²™å­è‡ªèº«çš„æ³•çº¿è´´å›¾
nDirTS.xy *= _NormalInt;

//è½¨è¿¹æ³•çº¿
float4 var_RutTex = tex2D(_RutRTTex, i.uv_Rut); //è¿™ä¸ªæŒ‡çš„æ˜¯ç¬”åˆ·ï¼Œå³è½¨è¿¹æ¸²æŸ“çº¹ç†ï¼Œä»ä¸Šé¢C#è„šæœ¬çš„paintRTå‚æ•°ä¼ å…¥
float3 nDirTS_Rut = (2.0 * var_RutTex.xyz - 1.0); //è‡ªå·±åšçš„æ³•çº¿+displacement mapï¼Œæ‹†å‡ºRGBé€šé“ï¼ˆä»£è¡¨æ³•çº¿ï¼‰å¹¶è‡ªè¡Œunpack
nDirTS_Rut.xy *= _RutHeight * _RutNormalInt;

//æ³•çº¿æ··åˆ
nDirTS = normalize(float3(nDirTS.xy / nDirTS.z + nDirTS_Rut.xy / nDirTS_Rut.z, 1.0)); //å‚è€ƒhttps://www.gameres.com/896279.htmlé‡Œé¢çš„Partial Derivative Blending
```

> æ³¨ï¼šæœ¬ç¯‡å‚è€ƒçš„å¤åˆ»æ²™æ¼ è¶³è¿¹çš„çŸ¥ä¹æ–‡ç« åœ¨è¿™å¥`nDirTS = normalize(float3(nDirTS.xy / nDirTS.z + nDirTS_Rut.xy / nDirTS_Rut.z, 1.0));`ä¸­å¹¶æ²¡æœ‰normalizeçš„æ“ä½œï¼Œä¸è¿‡åœ¨åé¢TBNçŸ©é˜µç›¸ä¹˜çš„æ—¶å€™æœ‰åšnormalizeæ“ä½œï¼Œæ‰€ä»¥åº”è¯¥ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œè¿™é‡Œæå‰normalizeä¸€ä¸‹ï¼Œä¿è¯è·ŸPartial Derivative Blendingæ–¹æ³•ä¿æŒä¸€è‡´ã€‚ï¼ˆè¡¥å……ï¼šåœ¨`RutPaint.shader`æ–‡ä»¶ä¸­ï¼Œä½œè€…çš„æ³•çº¿æ··åˆæœ‰è¿›è¡Œnormalizeæ“ä½œï¼‰

å‚è€ƒåšå®¢ä¸­ï¼Œä½œè€…ç”¨SDåšäº†ä¸€ä¸ªç®€æ˜“ç¬”åˆ·ï¼š

![img](./assets/v2-6147acf78b5d8e8ac35083ad7fb56f86_r.jpg)

> æ³¨ï¼šSDç”¨çš„è¿˜ä¸æ˜¯å¾ˆç†Ÿï¼Œä½†æ˜¯æ„Ÿè§‰åº”è¯¥ä¸éš¾ï¼Œä¹Ÿæ˜¯è¿è¿çœ‹è¿å‡ºæ¥çš„ã€‚

è¾“å…¥åå¯ä»¥å¾—åˆ°ä¸‹é¢çš„æ•ˆæœï¼ˆä¸ºæ–¹ä¾¿æ¼”ç¤ºï¼Œå·¦åŠè¾¹æ˜¾ç¤ºæ³•çº¿ï¼Œå³åŠè¾¹æ˜¾ç¤ºé«˜åº¦ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°æ··åˆçš„æ•ˆæœè¿˜æ˜¯å¯ä»¥çš„ï¼š

![åŠ¨å›¾](./assets/v2-21087e86056ee075ca0cc8ed7806fd8e_b.webp)

â€‹	è‡³äºç¬”åˆ·å±€éƒ¨ç»˜åˆ¶çš„å®ç°ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ä¼ªä»£ç ï¼ˆå³åœ¨åŸæœ¬çš„UV0ä¸­æŒ–å‡ºä¸€å—æ–¹å½¢æ¥åšå±€éƒ¨UVï¼‰ï¼Œå¹¶ä¸”ç›¸åŒçš„æ€è·¯åœ¨ä¹‹åçš„åœ°å½¢ç»˜åˆ¶èŒƒå›´è·Ÿéšä¸­ä¹Ÿä¼šå†æ¬¡ç”¨åˆ°ï¼š

```glsl
float Remap(float min, float max, float input)  //remapå‡½æ•°å°±æ˜¯æŠŠinputæ˜ å°„åˆ°minåˆ°maxä¹‹é—´
{
  float k = 1.0 / (max - min);
  float b = -min * k;
  return k * input + b;
}

float2 _BrushPosTS;//ç¬”åˆ·ä¸­å¿ƒUVåæ ‡
float _BrushRadius;//ç¬”åˆ·å½’ä¸€åŒ–åŠå¾„
float2 uv00 = _BrushPosTS - _BrushRadius;
float2 uv11 = _BrushPosTS + _BrushRadius;
float2 uv_Brush = float2(Remap(uv00.x, uv11.x, i.uv0.x), Remap(uv00.y, uv11.y, i.uv0.y));
```



------

### ï¼ˆ3ï¼‰ä¸åœ°å½¢çš„è”åŠ¨

â€‹	å‚ç…§ã€ŠåŸç¥ã€‹ä¸­çš„æ•ˆæœï¼Œåœ¨æ²™æ¼ ä¸­å¯èƒ½äº§ç”Ÿè½¨è¿¹çš„ç‰©ä½“å¯èƒ½ä¸æ­¢ä¸€ä¸ªã€‚ä»–ä»¬çš„ä½ç½®ä¼šå®æ—¶å‘ç”Ÿå˜åŒ–ï¼ˆå³å¯¹åº”shaderçš„ä½ç½®å‚æ•°ï¼‰ï¼Œå¹¶ä¸”è½¨è¿¹çš„æ·±æµ…å’Œå¤§å°ä¹Ÿå¯èƒ½äº§ç”Ÿå˜åŒ–ï¼ˆå³å¯¹åº”shaderçš„å¼ºåº¦ä¸åŠå¾„å‚æ•°ï¼‰ã€‚

â€‹	æ‰€ä»¥Paintæ–¹æ³•ï¼ˆä¸Šé¢C#è„šæœ¬ä¸­å†™çš„æ–¹æ³•ï¼‰ä¸­é™¤äº†åŸæœ¬çš„ç¬”åˆ·è´´å›¾ï¼Œè¿˜è‡³å°‘åº”å½“åŒ…å«ã€å½“å‰çš„ç‰©ä½“ä½ç½®ã€‘ã€ã€å½“å‰çš„ç»˜åˆ¶å¼ºåº¦ã€‘ä¸ã€å½“å‰çš„ç»˜åˆ¶åŠå¾„ã€‘è¿™ä¸‰ä¸ªå‚æ•°ã€‚**å€˜è‹¥å…¶ä¸­çš„ä½ç½®å’ŒåŠå¾„å‚æ•°è¿˜æ˜¯ä¸–ç•Œç©ºé—´ä¸‹çš„å°ºåº¦ï¼Œåœ¨æ–¹æ³•ä¸­è¿˜éœ€è¦è¿›è¡Œä¸–ç•Œç©ºé—´åˆ°UVç©ºé—´çš„è½¬åŒ–ã€‚**



#### ï¼ˆaï¼‰å±€éƒ¨è½¨è¿¹ç»˜åˆ¶

â€‹	æ ¹æ®ï¼ˆ3ï¼‰ä¸­çš„åˆ†æï¼Œæœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼Œå³å¦‚ä½•è¿›è¡Œä¸–ç•Œç©ºé—´åˆ°UVç©ºé—´çš„è½¬åŒ–ï¼Ÿè€ƒè™‘åˆ°åƒæ˜¯æ²™æ¼ ä¹‹ç±»çš„åœ°å½¢å¤šæ˜¯è¿‘ä¼¼äº`z=F(x,y)`å½¢å¼çš„é«˜åº¦åœºï¼ˆå³æ²¡æœ‰æ´ç©´ç»“æ„é‚£æ ·çš„çºµå‘å±‚æ¬¡ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥å‚è€ƒ3.ï¼ˆ2ï¼‰æœ«å°¾æ„é€ å±€éƒ¨UVçš„æ€è·¯ï¼Œåœ¨ä¸–ç•Œç©ºé—´çš„ä¿¯è§†æŠ•å½±è§†è§’ï¼ˆå³XZå¹³é¢ï¼‰ä¸‹è§„å®šä¸€ä¸ªæ–¹å½¢åŒºåŸŸï¼Œç„¶åå°†è¿™ä¸ªåŒºåŸŸå†…ä¸–ç•Œåæ ‡çš„xzåˆ†é‡å½’ä¸€åŒ–åå½“ä½œUVï¼ˆè¿™ä¹Ÿæ˜¯shaderä¸­ä¸€ç§å¸¸ç”¨å¥—è·¯ï¼‰ï¼Œä»¥æ­¤å¯¹è½¨è¿¹å›¾è¿›è¡Œé‡‡æ ·å³å¯ã€‚ï¼ˆä½†è¿™ä¹Ÿå°±æ„å‘³ç€è½¨è¿¹é›•åˆ»ä»…å±€é™åœ¨XZå¹³é¢ä¸Šï¼Œè€Œä¸åƒzbrushä¸­é‚£æ ·æ˜¯ä»»æ„è§’åº¦çš„ï¼‰ã€‚

> todoï¼šä¹Ÿå°±æ˜¯è¯´å¦‚æœè¿™ä¸ªæ²™æ¼ çš„å¡é¢æ¯”è¾ƒæ–œçš„è¯ç”»ä¸Šå»çš„æ•ˆæœå¯èƒ½æ²¡é‚£ä¹ˆå¥½ï¼Œè¿™ä¸€ç‚¹çœ‹çœ‹åç»­æœ‰æ²¡æœ‰ä»€ä¹ˆä¼˜åŒ–æ€è·¯å§ã€‚

â€‹	å†å‚è€ƒçš„çŸ¥ä¹æ–‡ç« ä¸­ï¼Œä½œè€…å®šä¹‰æ–¹å½¢åŒºåŸŸçš„æ–¹å¼æ˜¯å–å…¶å·¦ä¸‹ä¸å³ä¸Šç‚¹çš„ä¸–ç•Œåæ ‡æ„æˆä¸€ä¸ªå››ç»´å‘é‡ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

![åŠ¨å›¾](./assets/v2-4bdb1d172780ed4fc77fb084b79039ae_b.webp)



#### ï¼ˆbï¼‰ç»˜åˆ¶åŒºåŸŸåŠ¨æ€è·Ÿéš

â€‹	å› ä¸ºç»˜åˆ¶è½¨è¿¹çš„æ–¹å½¢èŒƒå›´åªæ˜¯åœ°å½¢ä¸­çš„ä¸€ä¸ªå±€éƒ¨ï¼Œå¹¶ä¸”ç©å®¶æ§åˆ¶çš„è§’è‰²æ˜¯è¿åŠ¨çš„ï¼Œæ‰€ä»¥è¿™ä¸ªåŒºåŸŸçš„ä½ç½®ä¹Ÿåº”å½“æ˜¯åŠ¨æ€å˜åŒ–çš„ã€‚ä½œè€…è€ƒè™‘åˆ°äº†ä¸¤ç§å¯èƒ½å¯è¡Œçš„æ–¹æ¡ˆï¼ˆæœ€ç»ˆé‡‡ç”¨çš„æ˜¯ç¬¬äºŒç§ï¼Œæ¯”è¾ƒç®€å•ï¼‰ï¼š

- ï¼ˆ1ï¼‰ç»˜åˆ¶èŒƒå›´ç›¸å¯¹äºåœ°å½¢ä¸åŠ¨ï¼ŒæŠŠåœ°å›¾æŒ‰ä¸€å®šå¤§å°çš„æ–¹æ ¼åˆ†é…ï¼Œå½“ç©å®¶åˆ°è¾¾ä¸€ä¸ªæ–°åœ°å—æ—¶ï¼Œå¯åŠ¨ç©å®¶æ‰€åœ¨åœ°å—åŠå‘¨å›´8ä¸ªåœ°å—çš„ç»˜åˆ¶æ–¹æ³•ï¼Œç¦»å¼€æ—¶å†å…³é—­å¹¶å¸è½½åŒºåŸŸå¤–çš„RenderTextureç­‰åŠ¨æ€èµ„æºï¼ˆæœ‰ç‚¹åƒæ˜¯å¤§åœ°å›¾åˆ†åŒºå—åŠ¨æ€åŠ è½½çš„æ„æ€ï¼‰ï¼›
- ï¼ˆ2ï¼‰ç»˜åˆ¶èŒƒå›´çš„ä¸­å¿ƒå®æ—¶è·Ÿéšç©å®¶ï¼›

â€‹	é‡‡ç”¨æ–¹æ³•2çš„è¯ï¼Œæ¯å½“ç©å®¶å‘ç”Ÿç§»åŠ¨æ—¶ï¼Œè¿˜éœ€è¦é¢å¤–å‘shaderä¼ ä¸€ä¸ªUVåç§»å‘é‡æ¥ä½¿æ•´å¼ è½¨è¿¹å›¾å‘ç”Ÿåç§»ã€‚å‚è€ƒçš„çŸ¥ä¹æ–‡ç« å°†è¯¥åç§»é‡ä¸ä¹‹å‰çš„ç¬”åˆ·ä½ç½®å‚æ•°`_BrushPosTS`ï¼ˆç¬”åˆ·ä¸­å¿ƒçš„UVåæ ‡ï¼‰åˆå¹¶ä¸º`_BrushPosTS_Offset`å››ç»´å‘é‡ã€‚æ±‡æ€»ä¸Šé¢çš„æ€è·¯ï¼Œå®Œå–„åçš„Paintæ–¹æ³•å¦‚ä¸‹ï¼ˆéœ€è¦åŒæ—¶è€ƒè™‘ç©å®¶å’ŒNPCå¯¹æ²™æ¼ çš„ç»˜åˆ¶ï¼Œç©å®¶ä¸€èˆ¬å¤„äºç»˜åˆ¶çš„ä¸­å¿ƒï¼Œè€ŒNPCæ¯”å¦‚æ€ªçš„ç»˜åˆ¶èŒƒå›´åˆ™éœ€è¦çœ‹ç¦»è§’è‰²å¤šè¿œï¼‰ï¼š

```c#
public void Paint(Transform tfIN, Texture2D brushTex, float brushRadius, float brushInt)
{
  Vector4 pos_Offset;

  //å¦‚æœè¾“å…¥å¯¹è±¡æ˜¯ç©å®¶ï¼Œåˆ™é¢å¤–è®¡ç®—çº¹ç†åç§»ä¸åœ°å½¢æè´¨çš„èŒƒå›´å‚æ•°
  if (tfIN == playerTf)
  {
    //ä½ç§»å‘é‡è®¡ç®—
    Vector3 deltaDir01 = (playerTf.position - playerOldPos) / paintSize;
    pos_Offset = new Vector4(0.5f, 0.5f, deltaDir01.x, deltaDir01.z);

    //åœ°å½¢æè´¨èŒƒå›´æ›´æ–°
    playerOldPos = playerTf.position;
    float halfSize = paintSize / 2;
    Vector3 pos00 = playerOldPos - new Vector3(halfSize, 0, halfSize);
    Vector3 pos11 = playerOldPos + new Vector3(halfSize, 0, halfSize);
    groundMat.SetVector("_PaintRect", new Vector4(pos00.x, pos00.z, pos11.x, pos11.z));
  }

  //éç©å®¶ï¼Œè®¡ç®—å½“å‰å¯¹è±¡ç›¸å¯¹ç©å®¶çš„å½’ä¸€åŒ–ä½ç½®
  else
  {
    Vector3 deltaDir01 = (tfIN.position - playerTf.position) / paintSize;
    pos_Offset = new Vector4(0.5f + deltaDir01.x, 0.5f + deltaDir01.z, 0, 0);
  }

  //ç»˜åˆ¶æè´¨å‚æ•°é…ç½®
  paintMat.SetTexture("_BrushTex", brushTex);
  paintMat.SetVector("_BrushPosTS_Offset", pos_Offset);
  paintMat.SetFloat("_BrushRadius", brushRadius / paintSize);
  paintMat.SetFloat("_BrushInt", brushInt);

  //åˆ·æ–°æ¸²æŸ“çº¹ç†ï¼Œä¹‹å‰å·²ç»è¯´è¿‡äº†
  RenderTexture tempRT = RenderTexture.GetTemporary(paintRT.descriptor);
  Graphics.Blit(paintRT, tempRT, paintMat, 0);
  Graphics.Blit(tempRT, paintRT);
  RenderTexture.ReleaseTemporary(tempRT);
}
```

> è¡¥å……ï¼šåœ¨`RutPaint.shader`æ–‡ä»¶ä¸­ï¼Œä¼ å…¥shader`_BrushPosTS_Offset`å‚æ•°çš„pos_Offsetæ˜¯è¿™æ ·ç”¨çš„ï¼š
>
> ```glsl
> v2f vert(a2v i)
> {
>     v2f o;
>     //åæ ‡
>     o.posCS = TransformObjectToHClip(i.posOS.xyz);
>     //UV
>     o.uv0 = i.uv0;
>     o.uv_Main = i.uv0 + _BrushPosTS_Offset.zw;  //åœ¨åç»­ç‰‡å…ƒç€è‰²å™¨ä¸­ï¼Œuv_Mainç”¨äºé‡‡æ ·_MainTexï¼Œå³æ¯æ¬¡å åŠ è§£ç®—åçš„æ³•çº¿+displacementå€¼æ„æˆçš„è´´å›¾ï¼Œæ‰€ä»¥å¯¹äºplayeræ¥è¯´ï¼Œ_BrushPosTS_Offset.zwç­‰äºè¿åŠ¨æ–¹å‘ï¼ˆå› ä¸ºè§’è‰²åœ¨ç§»åŠ¨ï¼Œå¦‚æœè¿åŠ¨çš„è¯è¿™å¸§æ‰€åœ¨çš„UVåæ ‡è·Ÿä¸Šä¸€å¸§è‚¯å®šä¸ä¸€æ ·ï¼Œéœ€è¦è€ƒè™‘è¿åŠ¨å¸¦æ¥çš„å½±å“ï¼‰ï¼›å¯¹NPCæ¥è¯´åˆ™æ˜¯ï¼ˆ0ï¼Œ0ï¼‰
>     //ç¬”åˆ·å±€éƒ¨UVè®¡ç®—
>     float2 uv00 = _BrushPosTS_Offset.xy - _BrushRadius;	
>     float2 uv11 = _BrushPosTS_Offset.xy + _BrushRadius;//å¯¹äºplayeræ¥è¯´ï¼Œ_BrushPosTS_Offset.xy=ï¼ˆ0.5ï¼Œ0.5ï¼‰ï¼Œå¯¹äºNPCæ¥è¯´ï¼Œ_BrushPosTS_Offset.xy = ï¼ˆ0.5f + deltaDir01.x, 0.5f + deltaDir01.zï¼‰ï¼Œè¿™æ ·æ˜ å°„çš„èŒƒå›´å°±åŒ…å«äº†ç¦»è§’è‰²çš„è¿œè¿‘
>     o.uv_Brush = float2(Remap(uv00.x, uv11.x, i.uv0.x), Remap(uv00.y, uv11.y, i.uv0.y));
>     return o;
> }
> static float4 _Zero = float4(0.5, 0.5, 1.0, 0.5);
> float4 frag(v2f i) : SV_Target
> {
>     //è½¨è¿¹
>     float4 rutParams = tex2D(_MainTex, i.uv_Main);
> 
>     //ç¬”åˆ·
>     float4 var_BrushTex = tex2D(_BrushTex, i.uv_Brush);
>     float brushMask = step(0.0, i.uv_Brush.x) * step(i.uv_Brush.x, 1.0) * step(0.0, i.uv_Brush.y) * step(i.uv_Brush.y, 1.0);
> 
>     //æ³•çº¿æ··åˆ
>     float3 nDirTS_OLD = 2.0 * rutParams.xyz - 1.0;
>     float3 nDirTS_Brush = 2.0 * var_BrushTex.xyz - 1.0;
>     nDirTS_Brush.xy *= _BrushInt * brushMask;
>     float3 nDirTS_NEW = float3(nDirTS_OLD.xy / nDirTS_OLD.z + nDirTS_Brush.xy / nDirTS_Brush.z, 1.0);
>     nDirTS_NEW = 0.5 * normalize(nDirTS_NEW) + 0.5;
> 
>     //é«˜åº¦æ··åˆ
>     float h_OLD = 2.0 * rutParams.a - 1.0;
>     float h_Brush = 2.0 * var_BrushTex.a - 1.0;
>     h_Brush *= _BrushInt * brushMask;
>     float h_NEW = saturate(0.5 * (h_OLD + h_Brush) + 0.5);
> 
>     //è¾¹ç¼˜é®ç½© 
>     float edgeMask = saturate(Remap(0.5, 0.4, length(i.uv0 - float2(0.5, 0.5))));
> 
>     //æ··åˆ
>     float4 finalRGBA = edgeMask * float4(nDirTS_NEW, h_NEW) + (1.0 - edgeMask) * _Zero;
>     return finalRGBA;
> }
> ```
>
> è¡¥å……ï¼š
>
> ã€1ã€‘åœ¨è¿è¡Œç¨‹åºçš„æ—¶å€™ï¼Œshaderçš„_MainTexæ˜¯è¿™æ ·çš„ï¼š
>
> ![image-20240718155935256](./assets/image-20240718155935256.png)
>
> RGBé€šé“æ˜¯æ³•çº¿ï¼ŒAé€šé“æ˜¯displacement çš„å€¼ï¼Œå¹¶ä¸”è¿™å¼ å›¾æ˜¯å®æ—¶æ›´æ–°çš„ã€‚
>
> ã€2ã€‘**==è¿™éƒ¨åˆ†ç¡®å®æ¯”è¾ƒç»•ï¼Œç†è§£æ¸…æ¥šåéœ€è¦è®°ä½ï¼Œä¸‹æ¬¡å¦‚æœæƒ³è¦å®ç°ä»¥Aä¸ºä¸­å¿ƒï¼ŒåŒæ—¶Bï¼ŒCï¼ŒDç­‰ç‰©ä½“ä¹Ÿè¦å¯¹æŸå¼ è´´å›¾è¿›è¡Œé‡‡æ ·/ä¿®æ”¹æ—¶ï¼ŒUVçš„å˜åŒ–ï¼Œä»¿ç…§ä¸Šé¢çš„`Paint`å‡½æ•°æŠ„å°±è¡Œã€‚==**

â€‹	ä»¿ç…§ä¹‹å‰è¯´åˆ°çš„PSä¸­çš„â€ç»˜åˆ¶é—´è·â€œå‚æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™æ¯ä¸ªç‰©ä½“é™„åŠ ä¸€ä¸ªç±»ä¼¼çš„å±æ€§stepLengthï¼Œå³å½“ç‰©ä½“çš„ä½ç§»ï¼ˆæœ¬æ–‡ä¸­ä½¿ç”¨XZé¢çš„æŠ•å½±è·ç¦»ï¼‰è¶…è¿‡stepLengthæ—¶æ‰è°ƒç”¨ä¸€æ¬¡Paintæ–¹æ³•ï¼Œå¤§è‡´æ˜¯å¦‚ä¸‹è¿‡ç¨‹ï¼š

```c#
public Texture2D brushTex;//ç¬”åˆ·æ³•çº¿é«˜åº¦çº¹ç†
public float brushRadius;//ç¬”åˆ·åŠå¾„
public float brushInt;//ç¬”åˆ·å¼ºåº¦
public float stepLength;//ç»˜åˆ¶é—´éš”

private Vector2 oldPosXZ;//ä¸Šæ¬¡ç»˜åˆ¶çš„XZé¢æŠ•å½±ä½ç½®
void Start()
{
  oldPosXZ = this.transform.position;
}

public void Update()
{
  Vector2 newPosXZ = new Vector2(transform.position.x, transform.position.z);
  if (transform.hasChanged && (newPosXZ - oldPosXZ).sqrMagnitude >= stepLength * stepLength)
  {
    Paint(this.transform, brushTex, brushRadius, brushInt);
    oldPosXZ = newPosXZ;
    transform.hasChanged = false; //è¿™ä¸ªtransform.hasChangedç”¨æ¥è¡¨ç¤ºè‡ªä»ä¸Šæ¬¡transform.hasChangedè¢«ç½®æˆfalseä¹‹åï¼Œtransformæ˜¯å¦è¢«ä¿®æ”¹äº†ï¼Œå‚è€ƒhttps://docs.unity3d.com/ScriptReference/Transform-hasChanged.html
  }
}
```

> è¡¥å……ï¼šè¿™ä¹Ÿæ˜¯ä¸€ç§ä¼˜åŒ–çš„æ€æƒ³ã€‚



## 4.Trouble Shooting

è¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒæ‚ï¼Œç›´æ¥å‚è€ƒåŸåšå®¢ç¬¬å››éƒ¨åˆ†çš„å¤„ç†å³å¯ã€‚ä¸è¿‡è¿˜æ˜¯æ€»ç»“ä¸€äº›å¯èƒ½æœ‰æ”¶è·çš„å†…å®¹ï¼š

### ï¼ˆ1ï¼‰ç²¾åº¦é—®é¢˜

â€‹	å‡è®¾æˆ‘ä»¬åœ¨å¤§ä¸–ç•Œä¸­ä»¥ç©å®¶ä¸ºä¸­å¿ƒè¦ç»˜åˆ¶çš„æ­£æ–¹å½¢åŒºåŸŸçš„è¾¹é•¿ä¸º64å•ä½é•¿åº¦ï¼ˆç±³ï¼‰ï¼Œé‚£ä¹ˆå°†è¿™64mçš„åŒºåŸŸæ¸²æŸ“åˆ°ä¸€å¼ 1024*1024åˆ†è¾¨ç‡çš„RTå›¾ä¸Šæ—¶ï¼Œæ¯åƒç´ å¯¹åº”çš„å•ä½é•¿åº¦ä¸º64/1024 = 0.0625mï¼Œè¿™ç§æƒ…å†µä¸‹ç”±äºæµ®ç‚¹æ•°è®¡ç®—ç²¾åº¦çš„é—®é¢˜å¸¦æ¥çš„è¯¯å·®æ˜¯ä¸å¯å¿½ç•¥çš„ã€‚ä½œè€…çš„è§£å†³æ–¹æ¡ˆæ˜¯**â€å°†ä½ç§»å‘é‡çš„å„åˆ†é‡æŒ‰RTåˆ†è¾¨ç‡å¯¹åº”çš„æœ€å°å•ä½é•¿åº¦è¿›è¡Œç¦»æ•£åŒ–æˆªæ–­â€œ**ï¼Œä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```c#
//å¦‚æœè¾“å…¥å¯¹è±¡æ˜¯ç©å®¶ï¼Œåˆ™é¢å¤–è®¡ç®—çº¹ç†åç§»ä¸åœ°å½¢æè´¨çš„èŒƒå›´å‚æ•°
if (tfIN == playerTf)
{
    //ä½ç§»å‘é‡æŒ‰çº¹ç†å°ºå¯¸ç¦»æ•£åŒ–ï¼ŒæŠµæ¶ˆé‡‡æ ·æ—¶çš„æŠ–åŠ¨
    Vector3 deltaDir01 = (playerTf.position - playerOldPos) / paintSize;
    int tempRtSize = (int)rtSize;
    deltaDir01 = deltaDir01 * tempRtSize;
    deltaDir01.x = Mathf.Floor(deltaDir01.x) / tempRtSize;
    deltaDir01.z = Mathf.Floor(deltaDir01.z) / tempRtSize;
    pos_Offset = new Vector4(0.5f, 0.5f, deltaDir01.x, deltaDir01.z);

    //åœ°å½¢æè´¨èŒƒå›´æ›´æ–°
    playerOldPos += deltaDir01 * paintSize;
    playerOldPos.y = playerTf.position.y;
    float halfSize = paintSize / 2;
    Vector3 pos00 = playerOldPos - new Vector3(halfSize, 0, halfSize);
    Vector3 pos11 = playerOldPos + new Vector3(halfSize, 0, halfSize);
    groundMat.SetVector("_PaintRect", new Vector4(pos00.x, pos00.z, pos11.x, pos11.z));
}

//éç©å®¶ï¼Œè®¡ç®—å½“å‰å¯¹è±¡ç›¸å¯¹ç©å®¶çš„å½’ä¸€åŒ–ä½ç½®
else
{
    Vector3 deltaDir01 = (tfIN.position - playerTf.position) / paintSize;
    pos_Offset = new Vector4(0.5f + deltaDir01.x, 0.5f + deltaDir01.z, 0, 0);
}
```

> todoï¼šè¿™é‡Œçš„ç²¾åº¦è¯¯å·®ä»¥åŠå¦‚ä½•æ¶ˆé™¤å…¶å¸¦æ¥çš„å½±å“æ„Ÿè§‰è¿˜æ˜¯æ²¡å¤ªæ‡‚ï¼Œä½†åº”è¯¥å°±æ˜¯æ¶ˆé™¤äº†ä¸€ä¸‹è¯¯å·®çš„å½±å“ã€‚



### ï¼ˆ2ï¼‰è¾¹ç¼˜é®ç½©

â€‹	é’ˆå¯¹å‰é¢çš„éƒ¨åˆ†ï¼ŒRTçš„WrapModeè®¾ç½®ä¸ºClampï¼Œè€Œåœ¨shaderé‡Œæš‚æ—¶åˆæ²¡æœ‰åšèŒƒå›´æˆªæ–­ï¼Œè¿™å°±ä¼šå¯¼è‡´å½“å›¾åƒçš„å¹³é“ºæ¨¡å¼è®¾ä¸ºClampï¼Œæ‰€æœ‰åœ¨é‡‡æ ·æ—¶UV<0çš„åˆ†é‡ä¼šæŒ‰0è¿›è¡Œé‡‡æ ·ï¼›UV>1çš„åˆ†é‡ä¼šæŒ‰1è¿›è¡Œé‡‡æ ·ï¼Œè§†è§‰ä¸Šå°±æ˜¯åœ¨è¾¹ç¼˜æ‹‰é•¿çš„æ•ˆæœã€‚ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯å¯ä»¥åœ¨ç¬”åˆ·ç»˜åˆ¶shaderæœ€ååŠ ä¸€ä¸ªåœ†å½¢çš„æ·¡åŒ–é®ç½©ä¹˜ä¸Šå»ï¼Œæˆ–è€…ä¸æ˜¯åœ†å½¢ï¼Œä¿è¯UVåœ¨0å’Œ1çš„åƒç´ å€¼éƒ½æ˜¯â€0â€œå€¼ä¸”è§†è§‰ä¸Šè¿‡æ¸¡è‡ªç„¶ä¸ä¼šç©¿å¸®å³å¯ï¼š

- éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºè½¨è¿¹å›¾çš„è‰²å€¼ç»è¿‡ç¼–ç ï¼Œæ‰€ä»¥å…¶åŸæœ¬åœ¨ç‰©ç†å«ä¹‰ä¸Šå¯¹åº”çš„0å€¼ï¼ˆæ³•çº¿ï¼ˆ0ï¼Œ0ï¼Œ1ï¼‰é«˜åº¦0ï¼‰ç»ç¼–ç åæ˜¯(0.5, 0.5, 1.0, 0.5)ã€‚

è¿™éƒ¨åˆ†çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```glsl
float4 frag(v2f i) : SV_Target
{
    //è½¨è¿¹
    float4 rutParams = tex2D(_MainTex, i.uv_Main);

    //ç¬”åˆ·
    float4 var_BrushTex = tex2D(_BrushTex, i.uv_Brush);
    float brushMask = step(0.0, i.uv_Brush.x) * step(i.uv_Brush.x, 1.0) * step(0.0, i.uv_Brush.y) * step(i.uv_Brush.y, 1.0);

    //æ³•çº¿æ··åˆ
    float3 nDirTS_OLD = 2.0 * rutParams.xyz - 1.0;
    float3 nDirTS_Brush = 2.0 * var_BrushTex.xyz - 1.0;
    nDirTS_Brush.xy *= _BrushInt * brushMask;
    float3 nDirTS_NEW = float3(nDirTS_OLD.xy / nDirTS_OLD.z + nDirTS_Brush.xy / nDirTS_Brush.z, 1.0);
    nDirTS_NEW = 0.5 * normalize(nDirTS_NEW) + 0.5;

    //é«˜åº¦æ··åˆ
    float h_OLD = 2.0 * rutParams.a - 1.0;
    float h_Brush = 2.0 * var_BrushTex.a - 1.0;
    h_Brush *= _BrushInt * brushMask;
    float h_NEW = saturate(0.5 * (h_OLD + h_Brush) + 0.5);

    //=======================è¾¹ç¼˜é®ç½©ï¼Œè¿™éƒ¨åˆ†å’Œä¸‹é¢çš„æ··åˆéƒ¨åˆ†æ˜¯é‡ç‚¹å†…å®¹==========
    float edgeMask = saturate(Remap(0.5, 0.4, length(i.uv0 - float2(0.5, 0.5))));  //è¿™ä¸ª0.5ï¼Œ0.4çš„å€¼æ˜¯è‡ªå®šä¹‰çš„ï¼Œå–å†³äºä¸‹é¢lerpçš„å¹…åº¦æ€ä¹ˆæ ·ï¼Œæˆ‘è°ƒæ•´äº†ä¸€ä¸‹åˆ°0.9ï¼Œ0.1æ•ˆæœä¹Ÿæ²¡æœ‰å˜å·®å¾ˆå¤š

    //æ··åˆ
    float4 finalRGBA = edgeMask * float4(nDirTS_NEW, h_NEW) + (1.0 - edgeMask) * _Zero;
    return finalRGBA;
}
```



### ï¼ˆ3ï¼‰å°è¯¯å·®æˆªæ–­

https://vdn6.vzuu.com/SD/585ae618-3cd2-11ed-8629-625c1b512dc7.mp4?pkey=AAWYFfuGhzAhtox-_w6-pWd3F7qmLu2PuoMs1_CtCZu-LT-W8lECfN-PneJZGKOQ-qfbolWZ2scaY829xW4eEZh4&bu=078babd7&c=avc.1.1&expiration=1721299942&f=mp4&pu=078babd7&v=ks6

â€‹	çœ‹ä¸€ä¸‹ä¸Šé¢çš„è§†é¢‘ï¼Œå½“æŠŠè½¨è¿¹çš„é«˜åº¦ç¼©æ”¾æˆ–æ³•çº¿å¼ºåº¦å‚æ•°æ‹‰çš„ç‰¹åˆ«é«˜æ—¶å°±ä¼šå‡ºç°ä¸Šé¢çš„æƒ…å†µï¼Œè¿™æ˜¯ç”±0å€¼ä¸å®Œå…¨æ˜¯0å¯¼è‡´çš„ã€‚å¯ä»¥ç”¨ç±»ä¼¼ä¸‹é¢çš„æ–¹æ³•æ¥æŠ¹å¹³å¾®å°è¯¯å·®ï¼š

```glsl
float height = tex2Dlod(_RutRTTex, float4(o.uv_Rut, 0, 0)).a;

float minError = 1.5 / 255;
//Â·Â·Â·
height = abs(height - 0.5) < minError ? 0.5 : height; //heightéå¸¸æ¥è¿‘äº0.5çš„å€¼ï¼Œå°±æŒ‰ç…§0.5æ¥ç®—
//Â·Â·Â·
float4 var_RutTex = tex2D(_RutRTTex, i.uv_Rut);
var_RutTex.xyw = abs(var_RutTex.xyw - 0.5) < minError ? 0.5 : var_RutTex.xyw;
```



------



## 5.æ—¶é—´æ·¡åŒ–

è¿™éƒ¨åˆ†çš„ä¸€äº›å°è¯•å¯ä»¥çœ‹ä¸€ä¸‹åŸåšå®¢æ–‡ç« ï¼šhttps://zhuanlan.zhihu.com/p/568051545ã€‚ä½œè€…æœ€åæå‡ºäº†ä¸€ç§æ¯”è¾ƒç®€å•çš„æ·¡åŒ–å®ç°æ–¹æ¡ˆï¼š

- ä¸ç®¡ä¸€ä¸ªç‚¹å½“å‰çš„é«˜åº¦æˆ–æ˜¯å…¶ä»–å±æ€§å¦‚ä½•ï¼Œåªè¦ä¸æ˜¯0ï¼ˆç¼–ç å0.5ï¼‰ï¼Œå°±è®©å®ƒåŒ€é€Ÿå‘ç€0å˜åŒ–ï¼Œåœ¨shaderä¸­çš„å†™æ³•å¦‚ä¸‹ï¼š

```glsl
height_NEW = height_OLD - sign(height_OLD) * unity_DeltaTime.x / _AttenTime;
```

- å…¶ä¸­ï¼Œsignæ–¹æ³•è¿”å›è¾“å…¥å€¼çš„ç¬¦å·ï¼ˆå¤§äº0è¿”å›1ï¼›å°äº0è¿”å›-1ï¼Œç­‰äº0è¿”å›0ï¼‰ï¼›unity_DeltaTime.xæ˜¯æ¸²æŸ“å½“å‰å¸§æ‰€æ¶ˆè€—çš„æ—¶é—´ï¼›_AttenTimeæ˜¯é«˜åº¦ä¸º1çš„ç‚¹å®Œå…¨è¡°å‡åˆ°0æ‰€éœ€çš„æ—¶é—´ã€‚
- å¯¹äºæ³•çº¿è¡°å‡ï¼Œå…¶å®åœ¨ä»»æ„ç‚¹çš„é«˜åº¦éƒ½æŒ‰ä¸Šè¿°è§„åˆ™å˜åŒ–æ—¶ï¼Œç›¸å½“äºæ•´ä¸ªæ›²é¢éƒ½åœ¨åŒ€é€Ÿä¸‹é™ï¼Œæ‰€ä»¥åªè¦æ²¡æœ‰é™åˆ°0ï¼Œæ³•çº¿åœ¨æ•°å­¦ä¸Šæ˜¯ä¸ä¼šå˜çš„ã€‚ä½†è‹¥æ˜¯ç›´æ¥ç”¨ï¼š`if (height == 0) nDirTS = float3(0, 0, 1);`çš„æ–¹å¼å°†æ³•çº¿æˆªæ–­å°±ä¼šæœ‰ååˆ†é”åˆ©çš„æ·¡åŒ–æ•ˆæœã€‚æ‰€ä»¥æœ€åå®ç°çš„æ³•çº¿æ·¡åŒ–ä»£ç å¦‚ä¸‹ï¼ˆè·Ÿé«˜åº¦æ˜¯ç±»ä¼¼çš„ï¼Œä¸è¿‡æ€»æ„Ÿè§‰å¯èƒ½æœ‰æ›´å¥½çš„å®ç°æ–¹å¼ï¼‰ï¼š

```glsl
nDirTS_NEW.xy = nDirTS_OLD.xy - normalize(nDirTS_OLD.xy) * unity_DeltaTime.x / _AttenTime;
nDirTS_NEW = normalize(nDirTS_NEW);
```





### ï¼ˆ1ï¼‰**ARGB64**

ä¸Šé¢çš„ç®—æ³•é€»è¾‘çœ‹ä¸Šå»å¾ˆå®Œç¾ï¼Œä½†è¿è¡Œå°±ä¼šå‘ç°æ²¡å•¥å˜åŒ–ï¼Œå¯¼è‡´è¿™ä¸ªbugçš„åŸå› è¿˜æ˜¯ç²¾åº¦ã€‚æ›´è¿›ä¸€æ­¥è¯´ï¼Œæ˜¯RenderTextureçš„é¢œè‰²æ ¼å¼ã€‚

- å‚è€ƒ4.1ä¸­RenderTextureçš„é»˜è®¤è®¾ç½®ï¼Œå…¶é¢œè‰²æ ¼å¼é»˜è®¤æ˜¯R8G8B8A8_UNORMï¼Œå³å¯¹åº”C#ä»£ç ä¸­çš„RenderTextureFormat.ARGB32ï¼Œä½†å¯¹äºè¡°å‡çš„é«˜åº¦è®¡ç®—æ¥è¯´ï¼Œ8ä½æµ®ç‚¹æ•°ï¼ˆå³å¯¹åº”2^8=256é˜¶ç°åº¦ï¼Œæœ€ä½çš„æœ‰æ•ˆå°æ•°å¤§æ¦‚0.0039ï¼‰çš„ç²¾åº¦æ˜¯ä¸å¤Ÿç”¨çš„ã€‚
- å‚è€ƒä¸Šé¢çš„é«˜åº¦è¡°å‡ç®—æ³•ï¼Œå‡å¦‚_AttenTimeç»™åˆ°10ï¼Œè€Œunity_DeltaTime.xä¸€èˆ¬å¯èƒ½ä¹Ÿå°±åå‡ ç”šè‡³å‡ æ¯«ç§’ï¼Œä¸€é™¤ç›´æ¥å°äº0.0039ï¼Œåœ¨ç¨‹åºä¸­å¯èƒ½ç›´æ¥è‡ªåŠ¨æˆªæ–­ä¸º0ï¼Œæ‰€ä»¥å¯¼è‡´æ²¡æœ‰è¡°å‡ã€‚
- è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œé‡‡ç”¨RenderTextureFormat.ARGB64æˆ–æ›´é«˜ç²¾åº¦çš„é¢œè‰²æ ¼å¼å³å¯ã€‚



## 6.ä¸€äº›ç»†èŠ‚

è¿™é‡ŒåŸæ–‡ï¼ˆhttps://zhuanlan.zhihu.com/p/568051545ï¼‰æåˆ°äº†ä¸¤ä¸ªé¢å¤–ç»†èŠ‚ä¸Šçš„é—®é¢˜ï¼š

- ï¼ˆ1ï¼‰æ€§èƒ½ä¼˜åŒ–ï¼šåštessellationçš„æ—¶å€™ï¼Œå¯ä»¥åŸºäºå½’ä¸€åŒ–XZé¢æŠ•å½±è·ç¦»ï¼ˆå³ç»˜åˆ¶æ¡†å†…æ„é€ çš„å±€éƒ¨UVç©ºé—´ä¸­çš„è·ç¦»ï¼‰è¿›è¡Œä¼˜åŒ–ã€‚è¯¥ä¼˜åŒ–å‘ç”Ÿåœ¨2ç»†åˆ†è§„åˆ™é…ç½®é˜¶æ®µã€‚å®ç°ä¸Šå¤§è‡´åˆ†ä¸ºä¸¤æ­¥ï¼šåˆ¤æ–­å½“å‰ä¸‰è§’å½¢çš„XZé¢æŠ•å½±æ˜¯å¦å­˜åœ¨æŸä¸€é¡¶ç‚¹åœ¨ç»˜åˆ¶çŸ©å½¢çš„èŒƒå›´å†…ï¼›æ»¡è¶³ä¸Šä¸€æ¡ä»¶æ—¶ï¼Œæ ¹æ®è¾¹çš„ä¸­ç‚¹åˆ°ç©å®¶çš„è·ç¦»åšlerpè®¡ç®—è¯¥è¾¹çš„ç»†åˆ†æ®µæ•°ï¼Œæ ¹æ®ä¸‰è§’å½¢é‡å¿ƒåˆ°ç©å®¶çš„è·ç¦»åšlerpè®¡ç®—å†…éƒ¨çš„ç»†åˆ†ç³»æ•°ã€‚
  - éœ€è¦æ³¨æ„çš„æ˜¯é¡¶ç‚¹ç´¢å¼•å’Œè¾¹ç´¢å¼•çš„å¯¹åº”æ–¹å¼ã€‚åœ¨ç»†åˆ†é…ç½®æŒ‰æ–‡æ¡£ä¸Šé¢æ‰€å†™çš„å†…å®¹è¿›è¡Œé…ç½®æ—¶ï¼Œè¾¹0ä¸¤ç«¯çš„é¡¶ç‚¹ç´¢å¼•æ˜¯1ï¼Œ2ï¼›è¾¹1ä¸¤ç«¯çš„é¡¶ç‚¹ç´¢å¼•æ˜¯2ï¼Œ0ï¼›è¾¹2ä¸¤ç«¯çš„é¡¶ç‚¹ç´¢å¼•æ˜¯0ï¼Œ1ã€‚è¯¥å¯¹åº”æ–¹å¼å¯èƒ½ä¼šå› éƒ¨åˆ†é…ç½®æ›´æ”¹è€Œå˜åŒ–ï¼ˆå¦‚[outputtopology("triangle_cw")]ï¼‰

ä¼˜åŒ–å®Œçš„ä»£ç å¦‚ä¸‹ï¼š
```c#
//å¯¹ä¸‰è§’é¢æˆ–å…¶ä»–å½¢å¼å›¾å…ƒè¿›è¡Œç»†åˆ†çš„é…ç½®
struct TessParam
{
    float EdgeTess[3]	: SV_TessFactor;//å„è¾¹ç»†åˆ†æ•°
    float InsideTess	    : SV_InsideTessFactor;//å†…éƒ¨ç‚¹ç»†åˆ†æ•°
};

//ä¸‰è§’æ˜¯å¦å­˜åœ¨é¡¶ç‚¹åŒ…å«åœ¨çŸ©å½¢å†…
bool IsTriRectCross2D(float2 triVert[3], float4 rect)
{
    for (uint idx = 0; idx < 3; idx++)
    {
        if (triVert[idx].x >= rect.x && triVert[idx].x <= rect.z && triVert[idx].y >= rect.y && triVert[idx].y <= rect.w)
        {
            return true;
        }
    }
    return false;
}

TessParam ConstantHS(InputPatch<v2t, 3> i, uint id : SV_PrimitiveID)
{
    TessParam o;

     //åˆ¤æ–­å½“å‰ä¸‰è§’é¢ä¸è½¨è¿¹çš„çŸ©å½¢èŒƒå›´æ˜¯å¦å­˜åœ¨äº¤é›†
     float2 triVert[3] = { i[0].posWS.xz, i[1].posWS.xz, i[2].posWS.xz };
     if (IsTriRectCross2D(triVert, _PaintRect))
     {
         //è®¡ç®—è¾¹ä¸å›¾å…ƒçš„ä¸­å¿ƒ
         float2 edgeUV_Rut[3] = { 
             0.5 * (i[1].uv_Rut + i[2].uv_Rut),
             0.5 * (i[2].uv_Rut + i[0].uv_Rut),
             0.5 * (i[0].uv_Rut + i[1].uv_Rut)
         };
         float2 centerUV_Rut = (i[0].uv_Rut + i[1].uv_Rut + i[2].uv_Rut) / 3.0;

         //åŸºäºUVè·ç¦»è¿›è¡Œç»†åˆ†æ®µæ•°åˆ¤æ–­
         for (uint idx = 0; idx < 3; idx++)
         {
             float lerpT = 2.0 * length(edgeUV_Rut[idx] - float2(0.5, 0.5));
             lerpT = pow(saturate(lerpT), _TessPow);
             o.EdgeTess[idx] = lerp(_TessStep, 1.0, lerpT);
         }
         float lerpT = 2.0 * length(centerUV_Rut - float2(0.5, 0.5));
         lerpT = pow(saturate(lerpT), _TessPow);
         o.InsideTess = lerp(_TessStep, 1.0, lerpT);
     }
     else
     {
         o.EdgeTess[0] = 1;
         o.EdgeTess[1] = 1;
         o.EdgeTess[2] = 1;
         o.InsideTess = 1;
     }

    return o;
}
```



- ï¼ˆ2ï¼‰è§†å·®æ˜ å°„çš„å°è¯•ï¼šè€ƒè™‘åˆ°tessellationç§»åŠ¨ç«¯åº”è¯¥ç”¨ä¸äº†ï¼Œå¯ä»¥è€ƒè™‘ç”¨è§†å·®æ˜ å°„æ¥å®ç°è½¨è¿¹ï¼Œå…·ä½“å¯ä»¥çœ‹çŸ¥ä¹å¯¹åº”çš„å‚è€ƒæ–‡ç« ï¼Œè¿™é‡Œå°±ä¸è´´äº†ã€‚



# äºŒã€ä»£ç 





# ä¸‰ã€Take Away

- ã€1ã€‘Tessellation shaderçš„å…·ä½“åº”ç”¨ï¼Œè¿™é‡Œçš„æ²™åœ°ä½¿ç”¨äº†Tessellation shaderï¼Œå…·ä½“çš„å†™æ³•åœ¨å‰æ–‡æœ‰è¿›è¡Œä»‹ç»ã€‚
- ã€2ã€‘

